stages:
  - build

variables:
  NUITKA_assume_yes_for_downloads: "yes"
  PYTHONHTTPSVERIFY: "0"

build_job:
  stage: build
  tags:
    - saas-windows-medium-amd64

  rules:
    - if: $CI_PIPELINE_SOURCE == "push"
      when: manual
      allow_failure: true

  script:
    - 'echo "Step 1: Installing Python 3.12 via Chocolatey..."'
    - 'choco install python --version=3.12.0 -y --allow-downgrade --no-progress'

    - 'echo "Step 2: Refreshing Environment Paths..."'
    - '$env:Path = [System.Environment]::GetEnvironmentVariable("Path","Machine") + ";" + [System.Environment]::GetEnvironmentVariable("Path","User")'

    - 'echo "Step 3: Installing Dependencies..."'
    - 'python -m pip install --upgrade pip'
    - 'python -m pip install nuitka customtkinter Pillow python-docx zstandard'

    - 'echo "Step 4: Building Standalone Executable with Metadata..."'
    - 'python -m nuitka --standalone --onefile --windows-console-mode=disable --enable-plugin=tk-inter --include-package=customtkinter --assume-yes-for-downloads --windows-icon-from-ico=src/assets/app_icon.ico --include-data-file=src/assets/app_icon.ico=src/assets/app_icon.ico --onefile-tempdir-spec="%TEMP%/Click_Tool_%PID%" --windows-company-name="Himansu Kumar" --windows-product-name="Click! Screenshot Tool" --windows-file-version="1.0.0.0" --windows-product-version="1.0.0.0" --windows-file-description="Professional Screenshot Automation Utility" "src/main.py"'
    
    - 'echo "Step 5: Renaming executable..."'
    - 'ren main.exe "Click!.exe"'

  artifacts:
    name: "Click_Tool_Freeware_Pack"
    paths:
      - "Click!.exe"
      - "LICENSE.md"
      - "README.md"
      - "Click! - Guide.pdf"
    expire_in: never