name: "Click!"
run-name: "Build v${{ github.event.inputs.version }} by @${{ github.actor }}"

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Set Version Number (e.g., 1.0.0)"
        required: true
        default: "1.0.0"
        type: string

jobs:
  build:
    runs-on: windows-latest

    permissions:
      contents: write

    steps:
      # -----------------------------
      # Checkout
      # -----------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # -----------------------------
      # Python setup (x64 only)
      # -----------------------------
      - name: Set up Python 3.12 (x64)
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          architecture: "x64"
          cache: "pip"

      # -----------------------------
      # Install dependencies
      # -----------------------------
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      # -----------------------------
      # Build executable (PyInstaller)
      # -----------------------------
      - name: Build executable (PyInstaller)
        shell: powershell
        run: |
          pyinstaller --noconfirm "Click!.spec"

      # -----------------------------
      # Rename output
      # -----------------------------
      - name: Rename output
        shell: powershell
        run: |
          if (Test-Path "dist/Click!.exe") {
            Move-Item "dist/Click!.exe" "Click!.exe" -Force
          } else {
            Write-Error "Build artifact not found!"
            exit 1
          }

      # -----------------------------
      # Generate SHA256 checksums
      # -----------------------------
      - name: Generate SHA256 checksums
        shell: powershell
        run: |
          certutil -hashfile "Click!.exe" SHA256 > Click!.exe.sha256
          certutil -hashfile "README.md" SHA256 > README.md.sha256
          certutil -hashfile "LICENSE.md" SHA256 > LICENSE.md.sha256
          certutil -hashfile "Click! - Guide.pdf" SHA256 > "Click! - Guide.pdf.sha256"

      # -----------------------------
      # VirusTotal batched scan
      # -----------------------------
      - name: VirusTotal scan (batched, including SHA256)
        shell: pwsh
        env:
          VT_API_KEY: ${{ secrets.VIRUSTOTAL_API_KEY }}
        run: |
          $files = @(
            'Click!.exe',
            'Click!.exe.sha256',
            'README.md',
            'README.md.sha256',
            'LICENSE.md',
            'LICENSE.md.sha256',
            'Click! - Guide.pdf',
            'Click! - Guide.pdf.sha256'
          )

          if (-not $env:VT_API_KEY) {
            Write-Error 'VirusTotal API key not set'
            exit 1
          }

          $reportFile = "vt_scan_results.txt"
          New-Item -ItemType File -Path $reportFile -Force
          Add-Content -Path $reportFile -Value "VirusTotal Scan Results - Click! v${{ github.event.inputs.version }}"
          Add-Content -Path $reportFile -Value "------------------------------------------------------------"

          $batchSize = 3
          $delaySeconds = 70

          for ($i = 0; $i -lt $files.Count; $i += $batchSize) {
            $endIndex = [Math]::Min($i + $batchSize - 1, $files.Count - 1)
            $batch = $files[$i..$endIndex]

            Write-Host ("Uploading batch: " + ($batch -join ', '))

            foreach ($file in $batch) {
              if (-not (Test-Path $file)) {
                Write-Error ("File not found: " + $file)
                exit 1
              }

              Write-Host ("→ Uploading " + $file + " to VirusTotal")

              $response = curl.exe `
                -s `
                -X POST "https://www.virustotal.com/api/v3/files" `
                -H ("x-apikey: " + $env:VT_API_KEY) `
                -F ("file=@" + '"' + $file + '"')

              if ($LASTEXITCODE -ne 0) {
                Write-Error ("VirusTotal upload failed for " + $file)
                exit 1
              }

              try {
                $json = $response | ConvertFrom-Json
                $id = $json.data.id
                $link = "https://www.virustotal.com/gui/file-analysis/$id"
                $line = "$file : $link"
                Add-Content -Path $reportFile -Value $line
                Write-Host ("✓ Uploaded " + $file + ". Report: " + $link)
              } catch {
                Write-Warning "Could not parse VT response for $file"
                Write-Host $response
                Add-Content -Path $reportFile -Value "$file : Uploaded (Link unavailable)"
              }
            }

            if ($i + $batchSize -lt $files.Count) {
              Write-Host ("Waiting " + $delaySeconds + " seconds before next batch...")
              Start-Sleep -Seconds $delaySeconds
            }
          }

          Write-Host 'All files uploaded to VirusTotal successfully. Report generated.'

      # -----------------------------
      # GitHub Release
      # -----------------------------
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "v${{ github.event.inputs.version }}"
          name: "Click! v${{ github.event.inputs.version }}"
          make_latest: true
          body: |
            ## Click!

            **Version:** ${{ github.event.inputs.version }}
            **Platform:** Windows x64

            ### Security
            - SHA256 checksums included
            - Files uploaded to VirusTotal (batched, rate-safe)
            - Scan results attached as `vt_scan_results.txt`

          files: |
            Click!.exe
            *.sha256
            README.md
            LICENSE.md
            "Click! - Guide.pdf"
            vt_scan_results.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
