name: "Click!"
run-name: "Build v${{ github.event.inputs.version }} by @${{ github.actor }}"

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Set Version Number (e.g., 1.0.0)"
        required: true
        default: "1.0.0"
        type: string

jobs:
  build:
    runs-on: windows-latest

    permissions:
      contents: write

    steps:
      # -----------------------------
      # Checkout
      # -----------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # -----------------------------
      # Python setup (x64 only)
      # -----------------------------
      - name: Set up Python 3.12 (x64)
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          architecture: "x64"
          cache: "pip"

      # -----------------------------
      # Install dependencies
      # -----------------------------
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      # -----------------------------
      # Build executable (PyInstaller)
      # -----------------------------
      - name: Build executable (PyInstaller)
        shell: powershell
        run: |
          pyinstaller --noconfirm --onefile --windowed `
            --name "Click!" `
            --paths . `
            --icon "src/assets/app_icon.ico" `
            --add-data "src/assets;src/assets" `
            --splash "src/assets/splash.png" `
            --hidden-import "PIL" `
            --hidden-import "PIL._tkinter_finder" `
            --hidden-import "customtkinter" `
            --collect-all "customtkinter" `
            src/main.py

      # -----------------------------
      # Rename output
      # -----------------------------
      - name: Rename output
        shell: powershell
        run: |
          if (Test-Path "dist/Click!.exe") {
            Move-Item "dist/Click!.exe" "Click!.exe" -Force
          } else {
            Write-Error "Build artifact not found!"
            exit 1
          }

      # -----------------------------
      # Create ZIP Archive
      # -----------------------------
      - name: Create ZIP Archive
        shell: powershell
        run: |
          $version = "${{ github.event.inputs.version }}"
          $zipName = "Click!-v$version.zip"
          
          # Create a temporary folder for zipping
          New-Item -ItemType Directory -Force -Path "release_package"
          
          # Copy files to the package folder
          Copy-Item "Click!.exe" "release_package/"
          Copy-Item "README.md" "release_package/"
          Copy-Item "LICENSE.md" "release_package/"
          Copy-Item "Click! - Guide.pdf" "release_package/"
          
          # Create the ZIP file
          Compress-Archive -Path "release_package/*" -DestinationPath $zipName
          
          # Generate SHA256 for the ZIP
          certutil -hashfile $zipName SHA256 > "$zipName.sha256"

      # -----------------------------
      # VirusTotal Scan (ZIP only)
      # -----------------------------
      - name: VirusTotal scan (ZIP only)
        shell: pwsh
        env:
          VT_API_KEY: ${{ secrets.VIRUSTOTAL_API_KEY }}
        run: |
          $version = "${{ github.event.inputs.version }}"
          $zipName = "Click!-v$version.zip"
          $files = @($zipName)

          if (-not $env:VT_API_KEY) {
            Write-Error 'VirusTotal API key not set'
            exit 1
          }

          $reportFile = "vt_scan_results.txt"
          New-Item -ItemType File -Path $reportFile -Force
          Add-Content -Path $reportFile -Value "VirusTotal Scan Results - Click! v$version"
          Add-Content -Path $reportFile -Value "------------------------------------------------------------"

          foreach ($file in $files) {
            if (-not (Test-Path $file)) {
              Write-Error ("File not found: " + $file)
              exit 1
            }

            Write-Host ("→ Uploading " + $file + " to VirusTotal")

            $response = curl.exe `
              -s `
              -X POST "https://www.virustotal.com/api/v3/files" `
              -H ("x-apikey: " + $env:VT_API_KEY) `
              -F ("file=@" + '"' + $file + '"')

            if ($LASTEXITCODE -ne 0) {
              Write-Error ("VirusTotal upload failed for " + $file)
              exit 1
            }

            try {
              $json = $response | ConvertFrom-Json
              $id = $json.data.id
              $link = "https://www.virustotal.com/gui/file-analysis/$id"
              $line = "$file : $link"
              Add-Content -Path $reportFile -Value $line
              Write-Host ("✓ Uploaded " + $file + ". Report: " + $link)
            } catch {
              Write-Warning "Could not parse VT response for $file"
              Write-Host $response
              Add-Content -Path $reportFile -Value "$file : Uploaded (Link unavailable)"
            }
          }

      # -----------------------------
      # GitHub Release
      # -----------------------------
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "v${{ github.event.inputs.version }}"
          name: "Click! v${{ github.event.inputs.version }}"
          make_latest: true
          body: |
            ## Click!

            **Version:** ${{ github.event.inputs.version }}
            **Platform:** Windows x64

            ### Security
            - SHA256 checksums included
            - **ZIP Archive scanned on VirusTotal**
            - Scan results attached as `vt_scan_results.txt`

          files: |
            Click!.exe
            Click!-v${{ github.event.inputs.version }}.zip
            Click!-v${{ github.event.inputs.version }}.zip.sha256
            vt_scan_results.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
