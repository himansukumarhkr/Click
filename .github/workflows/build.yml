name: "Click!"
run-name: "Build v${{ github.event.inputs.version }} by @${{ github.actor }}"

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Version (e.g. 1.0.0)"
        required: true
        default: "1.0.0"

jobs:
  build:
    runs-on: windows-latest

    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python 3.12 (x64)
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          architecture: x64
          cache: pip

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install nuitka cyclonedx-bom

      # -----------------------------
      # FIRST BUILD
      # -----------------------------
      - name: Build #1
        shell: powershell
        run: |
          python -m nuitka `
            --standalone `
            --onefile `
            --output-dir=build1 `
            --assume-yes-for-downloads `
            --windows-console-mode=disable `
            --enable-plugin=tk-inter `
            --include-package=customtkinter `
            --onefile-tempdir-spec="{TEMP}/Click_{PID}" `
            --windows-icon-from-ico="src/assets/app_icon.ico" `
            --windows-company-name="Himansu Kumar" `
            --windows-product-name="Click!" `
            --windows-file-version="${{ github.event.inputs.version }}" `
            --windows-product-version="${{ github.event.inputs.version }}" `
            src/main.py

      - name: Extract build #1
        shell: powershell
        run: |
          $exe = Get-ChildItem build1 -Recurse -Filter *.exe | Select-Object -First 1
          Copy-Item $exe.FullName Click-A.exe -Force

      # -----------------------------
      # SECOND BUILD (clean)
      # -----------------------------
      - name: Clean environment
        shell: powershell
        run: |
          Remove-Item build2 -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item $env:TEMP\Click_* -Recurse -Force -ErrorAction SilentlyContinue

      - name: Build #2
        shell: powershell
        run: |
          python -m nuitka `
            --standalone `
            --onefile `
            --output-dir=build2 `
            --assume-yes-for-downloads `
            --windows-console-mode=disable `
            --enable-plugin=tk-inter `
            --include-package=customtkinter `
            --onefile-tempdir-spec="{TEMP}/Click_{PID}" `
            --windows-icon-from-ico="src/assets/app_icon.ico" `
            --windows-company-name="Himansu Kumar" `
            --windows-product-name="Click!" `
            --windows-file-version="${{ github.event.inputs.version }}" `
            --windows-product-version="${{ github.event.inputs.version }}" `
            src/main.py

      - name: Extract build #2
        shell: powershell
        run: |
          $exe = Get-ChildItem build2 -Recurse -Filter *.exe | Select-Object -First 1
          Copy-Item $exe.FullName Click-B.exe -Force

      # -----------------------------
      # REPRODUCIBLE VERIFICATION
      # -----------------------------
      - name: Verify reproducible build
        shell: powershell
        run: |
          $hashA = (Get-FileHash Click-A.exe -Algorithm SHA256).Hash
          $hashB = (Get-FileHash Click-B.exe -Algorithm SHA256).Hash

          Write-Host "Build A: $hashA"
          Write-Host "Build B: $hashB"

          if ($hashA -ne $hashB) {
            Write-Error "❌ Build is NOT reproducible"
            exit 1
          }

          Write-Host "✅ Reproducible build verified"

      # -----------------------------
      # FINAL OUTPUT
      # -----------------------------
      - name: Normalize output
        shell: powershell
        run: |
          Copy-Item Click-A.exe "Click!.exe" -Force

      # -----------------------------
      # SIGN (OPTIONAL / EV READY)
      # -----------------------------
      - name: Code signing
        shell: powershell
        continue-on-error: true
        run: |
          signtool sign `
            /fd SHA256 `
            /td SHA256 `
            /tr http://timestamp.digicert.com `
            "Click!.exe"

      # -----------------------------
      # SHA256 + SBOM
      # -----------------------------
      - name: Generate SHA256
        shell: powershell
        run: |
          Get-FileHash "Click!.exe" -Algorithm SHA256 |
          ForEach-Object {
            "$($_.Hash)  Click!.exe"
          } | Out-File "Click!.exe.sha256" -Encoding ascii

      - name: Generate SBOM
        shell: powershell
        run: |
          cyclonedx-py -r -i requirements.txt -o "sbom.json"

      - uses: actions/upload-artifact@v4
        with:
          name: Click-x64
          path: |
            Click!.exe
            Click!.exe.sha256
            sbom.json

  release:
    needs: build
    runs-on: windows-latest

    permissions:
      contents: write

    steps:
      - uses: actions/download-artifact@v4
        with:
          path: dist

      - uses: softprops/action-gh-release@v2
        with:
          tag_name: "v${{ github.event.inputs.version }}"
          name: "Click! v${{ github.event.inputs.version }}"
          make_latest: true
          files: dist/**/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}